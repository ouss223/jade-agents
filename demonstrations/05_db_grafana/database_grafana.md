# PostgreSQL and Grafana Configuration

## PostgreSQL: Centralized Metrics Storage

### Database Initialization

PostgreSQL runs on the central server (192.168.1.100) with the following tables:

- **metrics**: stores resource measurements (CPU, RAM, I/O, network)
- **actions**: history of local reactions (throttle, kill processes)
- **audit_reports**: reports generated by AuditAgents

![PostgreSQL Status](../../media/checking%20postgresql%20status.png)

### Data Schema

The initialization script `/db/init.sql` creates the full structure:

```sql
CREATE TABLE metrics (
    id SERIAL PRIMARY KEY,
    agent_name VARCHAR(50),
    cpu DOUBLE PRECISION,
    ram BIGINT,
    disk BIGINT,
    disk_io VARCHAR(255),
    net_in BIGINT,
    net_out BIGINT,
    cpu_severity VARCHAR(20),
    ram_severity VARCHAR(20),
    disk_severity VARCHAR(20),
    disk_io_severity VARCHAR(20),
    net_severity VARCHAR(20),
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## Grafana: Real-Time Visualization

### Installation and Configuration

Grafana is installed and configured on the central server with data sources targeting the local PostgreSQL database.

![Grafana Check](../../media/checking%20grafana.png)

### Dashboards

Grafana dashboards provide a complete system view:

#### 1. CPU Usage per Machine

![CPU Graphs Normal](../../media/cpu%20graphs(normal).png)

![CPU Graphs Stressed](../../media/cpu%20graphs(stressed%20agent%201%20and%202).png)

#### 2. Network Consumption

![Network Graphs](../../media/network%20graphs.png)

#### 3. Memory Usage

![RAM Graphs Stressed](../../media/ram%20graphs(stress%20ed%20agent%205).png)

### External Access via Cloudflare Tunnel

To expose Grafana outside the GNS3 environment, a Cloudflare tunnel is configured:

```bash
cloudflared tunnel --url http://localhost:3000
```

This produces a secure public URL, bypassing bridge-mode limitations and providing reliable dashboard access.

## End-to-End Data Flow

1. **MonitoringAgents** collect metrics every 5 seconds
2. **ACL transmission** sends data to the CentralAgent
3. **PostgreSQL** stores metrics with timestamps
4. **Grafana** retrieves and visualizes data in real time
5. **Cloudflare tunnel** offers secure external access

## Architecture Benefits

- **Persistence**: long-term storage for historical analysis
- **Reactivity**: Grafana displays data with minimal delay
- **Accessibility**: external tunnel without directly exposing internal infrastructure
- **Traceability**: complete history of all events and actions

## Conclusion

Combining PostgreSQL and Grafana delivers a full storage and visualization stack, enabling intelligent supervision and data-driven decision making.
